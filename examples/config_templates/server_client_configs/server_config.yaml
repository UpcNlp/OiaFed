# ====================================
# FedCL 服务端配置模板
# ====================================
# 用于真实联邦学习环境的服务端配置
# 支持多客户端连接、异构配置、分布式部署

# 服务端基本信息
server:
  id: "fedcl_server"                        # 服务端唯一标识
  name: "FedCL Federation Server"           # 服务端名称
  type: "improved"                          # 服务端类型: basic/improved
  version: "1.0"                           # 配置版本

# 通信配置
communication:
  host: "localhost"                         # 服务端主机地址
  port: 8080                               # 服务端监听端口
  max_workers: 5                           # 最大并发工作线程数
  timeout: 60.0                           # 通信超时时间（秒）
  ssl_enabled: false                       # 是否启用SSL（生产环境建议true）
  ssl_cert_path: ""                        # SSL证书路径
  ssl_key_path: ""                         # SSL私钥路径

# 联邦学习配置
federation:
  num_rounds: 10                           # 联邦学习总轮次
  min_clients: 2                           # 每轮最少参与客户端数
  max_clients: 5                           # 每轮最多参与客户端数
  client_selection_strategy: "random"      # 客户端选择策略: random/performance_based/resource_aware
  client_fraction: 0.8                     # 客户端参与比例 (0.0-1.0)
  aggregation_strategy: "fedavg"           # 聚合策略: fedavg/fedprox/scaffold/custom
  
  # 高级联邦配置
  adaptive_aggregation:
    enabled: false                         # 是否启用自适应聚合
    performance_threshold: 0.1             # 性能差异阈值
    weight_adjustment: "dynamic"           # 权重调整策略: static/dynamic
  
  # 客户端管理
  client_management:
    registration_timeout: 300              # 客户端注册超时（秒）
    heartbeat_interval: 30                 # 心跳检测间隔（秒）
    max_idle_time: 600                     # 最大空闲时间（秒）

# 轮次配置
round_config:
  timeout: 300.0                           # 每轮超时时间（秒）
  min_client_updates: 2                    # 最少需要的客户端更新数
  retry_attempts: 3                        # 失败重试次数
  coordination_timeout: 60.0               # 协调超时时间（秒）
  
  # 轮次结束条件
  early_stopping:
    enabled: true                          # 是否启用早停
    patience: 5                            # 容忍轮次数
    min_delta: 0.001                       # 最小改进量
    monitor_metric: "accuracy"             # 监控指标

# 聚合器配置
aggregator:
  class: "fedavg"                          # 聚合器类别
  type: "FedAvgAggregator"                 # 聚合器类型
  weighting_strategy: "sample_size"        # 权重策略: uniform/sample_size/performance
  
  # 高级聚合配置
  advanced_config:
    clip_gradients: true                   # 是否梯度裁剪
    clip_value: 1.0                        # 梯度裁剪阈值
    noise_multiplier: 0.0                  # 差分隐私噪声倍数
    epsilon: 1.0                           # 隐私预算

# 全局模型配置
global_model:
  type: "SimpleMLP"                        # 模型类型: SimpleMLP/ResNet18/CNN
  input_size: 784                          # 输入特征维度
  hidden_sizes: [256, 128]                 # 隐藏层大小列表
  num_classes: 10                          # 输出类别数
  dropout_rate: 0.2                        # Dropout比率
  activation: "relu"                       # 激活函数: relu/tanh/sigmoid
  use_batch_norm: false                    # 是否使用批归一化
  
  # 模型初始化
  initialization:
    method: "xavier_normal"                # 初始化方法
    seed: 42                              # 初始化随机种子

# 服务端测试数据配置
test_data:
  server_test_data:
    type: "StandardDataLoader"             # 数据加载器类型
    dataset:
      name: "MNIST"                        # 数据集名称
      path: "data/MNIST"                   # 数据集路径
      split: "test"                        # 数据集分割: train/test/val
      download: true                       # 是否自动下载
      transform: "basic"                   # 数据变换: basic/augmented/custom
    
    loader_params:
      batch_size: 128                      # 批大小
      shuffle: false                       # 是否打乱数据
      num_workers: 0                       # 数据加载工作进程数
      drop_last: false                     # 是否丢弃最后一个不完整batch
      pin_memory: false                    # 是否将数据加载到GPU内存

# 评估配置
evaluation:
  metrics: ["accuracy", "loss", "f1"]      # 评估指标列表
  frequency: 1                             # 评估频率（每N轮评估一次）
  test_data_path: "data/MNIST"             # 测试数据路径
  
  # 评估任务配置
  tasks:
    - evaluator: "server_accuracy_evaluator"
      test_data: "server_test_data"
      enabled: true
    - evaluator: "server_loss_evaluator"
      test_data: "server_test_data"
      enabled: true
  
  # 高级评估配置
  advanced_metrics:
    confusion_matrix: true                 # 是否计算混淆矩阵
    class_wise_metrics: true               # 是否计算类别级指标
    roc_curve: false                       # 是否计算ROC曲线

# 服务端评估器配置
evaluators:
  server_accuracy_evaluator:
    evaluator:
      class: "accuracy"                    # 评估器类别
      metrics: ["accuracy", "precision", "recall", "f1"]
      test_data: "server_test_data"
      
  server_loss_evaluator:
    evaluator:
      class: "loss"                        # 损失评估器
      loss_function: "cross_entropy"       # 损失函数
      test_data: "server_test_data"

# 检查点配置
checkpoint:
  enabled: true                            # 是否启用检查点
  save_interval: 5                         # 保存间隔（每N轮保存一次）
  save_best: true                          # 是否保存最佳模型
  save_last: true                          # 是否保存最新模型
  checkpoint_dir: "checkpoints/server"     # 检查点保存目录
  max_checkpoints: 10                      # 最大保存检查点数量

# Hook配置
hooks:
  enabled: true                            # 是否启用Hook系统
  
  # 基础Hook
  checkpoint_hook:
    enabled: true
    priority: 0
    config:
      save_frequency: 5
      
  evaluation_hook:
    enabled: true
    priority: 5
    
  logging_hook:
    enabled: true
    priority: 10
    config:
      log_level: "INFO"
      
  # 服务端专用Hook
  client_management_hook:
    enabled: true
    priority: 1
    config:
      monitor_client_status: true
      auto_reconnect: true
      
  aggregation_hook:
    enabled: true
    priority: 2
    config:
      validate_updates: true
      detect_anomalies: true

# 系统配置
system:
  device: "cpu"                            # 计算设备: cpu/cuda/auto
  random_seed: 42                          # 系统随机种子
  num_threads: 4                           # CPU线程数
  memory_limit: "8GB"                      # 内存限制
  
  # GPU配置（如果使用GPU）
  gpu_config:
    device_ids: [0]                        # GPU设备ID列表
    memory_fraction: 0.8                   # GPU内存使用比例

# 日志配置
logging:
  level: "INFO"                            # 日志级别: DEBUG/INFO/WARNING/ERROR
  save_logs: true                          # 是否保存日志到文件
  log_frequency: 10                        # 日志输出频率
  log_dir: "logs/server"                   # 日志保存目录
  
  # 日志格式配置
  formatters:
    default: "[%(asctime)s][SERVER][%(name)s][%(levelname)s] %(message)s"
    detailed: "[%(asctime)s][SERVER][%(name)s][%(levelname)s][%(filename)s:%(lineno)d] %(message)s"
  
  # 高级日志配置
  advanced:
    log_model_updates: false               # 是否记录模型更新详情
    log_client_communications: true        # 是否记录客户端通信
    log_aggregation_details: false         # 是否记录聚合详情

# 安全配置
security:
  authentication:
    enabled: false                         # 是否启用身份验证
    method: "token"                        # 认证方法: token/certificate
    token_expiry: 3600                     # token过期时间（秒）
    
  encryption:
    enabled: false                         # 是否启用加密
    algorithm: "AES-256"                   # 加密算法
    
  privacy:
    differential_privacy: false            # 是否启用差分隐私
    secure_aggregation: false              # 是否启用安全聚合

# 监控配置
monitoring:
  enabled: true                            # 是否启用监控
  metrics:
    system_metrics: true                   # 系统指标监控
    federation_metrics: true               # 联邦学习指标监控
    client_metrics: true                   # 客户端指标监控
    
  alerts:
    enabled: false                         # 是否启用告警
    thresholds:
      cpu_usage: 90                        # CPU使用率告警阈值
      memory_usage: 85                     # 内存使用率告警阈值
      client_dropout_rate: 30              # 客户端掉线率告警阈值

# 实验配置
experiment:
  name: "server_template_experiment"       # 实验名称
  description: "FedCL服务端配置模板实验"    # 实验描述
  output_dir: "experiments/server_template" # 实验输出目录
  save_config: true                        # 是否保存配置文件
  save_results: true                       # 是否保存实验结果
