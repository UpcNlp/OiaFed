# MOE-FedCL é€šä¿¡æœºåˆ¶å‡çº§ä¸æ—¥å¿—åˆ†ç¦»è°ƒè¯•å®Œæˆæ€»ç»“

> ğŸ“… **è°ƒè¯•æ—¶é—´**: 2025å¹´8æœˆ3æ—¥  
> ğŸ¯ **ä»»åŠ¡ç›®æ ‡**: å½»åº•åˆ é™¤MockCommunicationManagerï¼Œå»ºç«‹å®é™…é€šä¿¡ç»„ä»¶ï¼Œå®Œå–„æ—¥å¿—åˆ†ç¦»åŠŸèƒ½  
> âœ… **çŠ¶æ€**: å·²å®Œæˆ

## ğŸ‰ ä¸»è¦æˆæœ

### âœ… é€šä¿¡æœºåˆ¶å®Œå…¨å‡çº§
- **åˆ é™¤**: MockCommunicationManager å®Œå…¨ç§»é™¤
- **å»ºç«‹**: SimpleCommunicationManager çœŸå®é€šä¿¡ç»„ä»¶
- **å®ç°**: å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨çœŸæ­£äº’å‘æ¶ˆæ¯
- **éªŒè¯**: æ¶ˆæ¯å‘é€ã€æ³¨å†Œã€å¿ƒè·³ç­‰æ“ä½œæ­£å¸¸å·¥ä½œ

### âœ… æ—¥å¿—åˆ†ç¦»åŠŸèƒ½å®Œå…¨ä¿®å¤
- **å®¢æˆ·ç«¯æ—¥å¿—**: æ¶ˆæ¯å‘é€ã€çŠ¶æ€å˜åŒ–ã€ç»„ä»¶åˆå§‹åŒ–ç­‰å®Œæ•´è®°å½•
- **æœåŠ¡å™¨æ—¥å¿—**: æ³¨å†Œå¤„ç†ã€çŠ¶æ€ç®¡ç†ã€å®¢æˆ·ç«¯åè°ƒç­‰ç‹¬ç«‹è®°å½•
- **é€šä¿¡æ—¥å¿—**: SimpleCommunicationManager æ“ä½œå•ç‹¬æ ‡è¯†
- **æ ¼å¼æ ‡å‡†**: CLIENT[id]ã€SERVER[id]ã€SimpleCommunicationManager[role:id]

## ğŸ”§ å…³é”®ä¿®å¤å†…å®¹

### 1. æ—¥å¿—å™¨ç»‘å®šé—®é¢˜ä¿®å¤

**é—®é¢˜æ ¹æº**:
```python
# é”™è¯¯ä»£ç  (federated_client.py:132) - å·²ä¿®å¤
self.logger = logger.bind(component=f"MultiLearnerClient:{client_id}")
```

**è§£å†³æ–¹æ¡ˆ**:
```python
# åˆ é™¤ä¸Šè¿°ä»£ç è¡Œï¼Œä½¿ç”¨åŸºç±»çš„æ­£ç¡®æ—¥å¿—å™¨
# æ³¨æ„ï¼šä¸è¦é‡æ–°ç»‘å®š self.loggerï¼ŒåŸºç±»å·²ç»æ­£ç¡®è®¾ç½®äº†ç»„ä»¶æ—¥å¿—å™¨
```

### 2. æ—¥å¿—ç®¡ç†å™¨ä¼˜åŒ–

**ç¡®ä¿æ­£ç¡®ç»‘å®š**:
```python
# fedcl/utils/logging_manager.py
self.loggers[logger_key] = logger.bind(
    component=f"CLIENT[{client_id}]",
    client_id=client_id  # å…³é”®ï¼šç»‘å®šclient_idç”¨äºè¿‡æ»¤
)
```

**è¿‡æ»¤å™¨é…ç½®**:
```python
filter=lambda record: record["extra"].get("client_id") == client_id
```

## ğŸ“Š æˆåŠŸéªŒè¯ç»“æœ

### å®¢æˆ·ç«¯æ—¥å¿—å†…å®¹éªŒè¯ (client_0.log)
```log
2025-08-03 22:06:47.148 | INFO | CLIENT[client_0] | Client logger initialized: client_0
2025-08-03 22:06:47.149 | INFO | CLIENT[client_0] | FederatedCommunicator initialized: client(client_0)
2025-08-03 22:06:51.905 | INFO | CLIENT[client_0] | Sending message type: 'registration' from client to server
2025-08-03 22:07:21.909 | INFO | CLIENT[client_0] | Sending message type: 'heartbeat' from client to server
2025-08-03 22:07:21.912 | WARNING | CLIENT[client_0] | Message response timeout: client_0_1754230011905
```

### å…³é”®æˆåŠŸæŒ‡æ ‡
- âœ… **æ¶ˆæ¯å‘é€æ—¥å¿—**: æ­£ç¡®è®°å½•åœ¨å®¢æˆ·ç«¯æ—¥å¿—ä¸­
- âœ… **çŠ¶æ€å˜åŒ–æ—¥å¿—**: åè°ƒå±‚å’Œæ§åˆ¶å±‚çŠ¶æ€å®Œæ•´è¿½è¸ª
- âœ… **ç»„ä»¶åˆå§‹åŒ–**: å¤šlearnerç»„ä»¶ã€è®­ç»ƒå¼•æ“ç­‰å®Œæ•´è®°å½•
- âœ… **é”™è¯¯å¤„ç†**: è¶…æ—¶ã€æ³¨å†Œå¤±è´¥ç­‰å¼‚å¸¸æƒ…å†µå®Œæ•´è®°å½•

## ğŸ› ï¸ è°ƒè¯•æŠ€å·§æ€»ç»“

### å¿«é€Ÿé—®é¢˜å®šä½
```bash
# 1. è·å–æœ€æ–°å®éªŒæ—¥å¿—
find logs -name "experiment_*" -type d | sort | tail -1

# 2. éªŒè¯æ—¥å¿—åˆ†ç¦»æ•ˆæœ
grep "Sending message" logs/experiment_xxx/clients/*.log

# 3. æ£€æŸ¥æ—¥å¿—å™¨ç»‘å®šé—®é¢˜
grep -r "self\.logger.*=" fedcl/ --include="*.py"

# 4. å¯¹æ¯”å…¨å±€vsç»„ä»¶æ—¥å¿—
diff <(grep "CLIENT\|client" logs/experiment_xxx/federated_training.log) \
     <(cat logs/experiment_xxx/clients/*.log)
```

### ç³»ç»Ÿè¯Šæ–­è„šæœ¬
```bash
#!/bin/bash
echo "ğŸ” MOE-FedCL ç³»ç»Ÿè¯Šæ–­"
LATEST=$(find logs -name "experiment_*" -type d | sort | tail -1)
echo "ğŸ“„ æœ€æ–°æ—¥å¿—: $LATEST"

# é”™è¯¯ç»Ÿè®¡
ERROR_COUNT=$(grep -c "ERROR" $LATEST/*.log $LATEST/clients/*.log 2>/dev/null || echo 0)
WARNING_COUNT=$(grep -c "WARNING" $LATEST/*.log $LATEST/clients/*.log 2>/dev/null || echo 0)
echo "âš ï¸  é”™è¯¯: $ERROR_COUNT, è­¦å‘Š: $WARNING_COUNT"

# ç»„ä»¶çŠ¶æ€
echo "ğŸ”§ ç»„ä»¶çŠ¶æ€:"
echo "   é€šä¿¡ç»„ä»¶: $(grep -c "SimpleCommunicationManager.*initialized" $LATEST/federated_training.log)"
echo "   å®¢æˆ·ç«¯: $(ls $LATEST/clients/ | wc -l)"
echo "   æœåŠ¡å™¨: $(ls $LATEST/server*.log | wc -l)"
```

## ğŸ“ é¡¹ç›®ç»“æ„ç†è§£

### æ ¸å¿ƒç»„ä»¶æ¶æ„
```
fedcl/
â”œâ”€â”€ communication/          # é€šä¿¡å±‚
â”‚   â””â”€â”€ communication_manager.py  # SimpleCommunicationManager
â”œâ”€â”€ federation/            # è”é‚¦å­¦ä¹ æ ¸å¿ƒ
â”‚   â”œâ”€â”€ coordinators/      # æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯åè°ƒå™¨
â”‚   â”‚   â”œâ”€â”€ base.py       # é€šä¿¡åŸºç±»
â”‚   â”‚   â”œâ”€â”€ federated_server.py
â”‚   â”‚   â””â”€â”€ federated_client.py
â”‚   â”œâ”€â”€ managers/          # å®¢æˆ·ç«¯ã€æ¨¡å‹ç®¡ç†å™¨
â”‚   â””â”€â”€ state/            # çŠ¶æ€ç®¡ç†
â”œâ”€â”€ utils/                # å·¥å…·
â”‚   â””â”€â”€ logging_manager.py # æ—¥å¿—åˆ†ç¦»ç®¡ç†å™¨
â””â”€â”€ implementations/      # å…·ä½“å®ç°
```

### é…ç½®æ–‡ä»¶ä½“ç³»
```
config/                   # ä¸»é…ç½®
â”œâ”€â”€ client_config.yaml
â”œâ”€â”€ server_config.yaml
â””â”€â”€ e2e_test_config.yaml

configs/                  # è¯¦ç»†é…ç½®æ¨¡æ¿
â”œâ”€â”€ federation.yaml
â”œâ”€â”€ communication.yaml
â””â”€â”€ algorithms/
```

### æµ‹è¯•ä½“ç³»
```
tests/
â”œâ”€â”€ test_federation_framework.py  # ä¸»è¦æµ‹è¯•
â”œâ”€â”€ integration/                  # é›†æˆæµ‹è¯•
â”œâ”€â”€ unit/                        # å•å…ƒæµ‹è¯•
â””â”€â”€ performance/                 # æ€§èƒ½æµ‹è¯•

run_tests.py                     # æµ‹è¯•è¿è¡Œå™¨
```

## ğŸ¯ å…³é”®å­¦ä¹ è¦ç‚¹

### 1. æ—¥å¿—åˆ†ç¦»åŸç†
- **ç»„ä»¶æ—¥å¿—å™¨**: æ¯ä¸ªç»„ä»¶(client/server)ç‹¬ç«‹çš„æ—¥å¿—å™¨
- **è¿‡æ»¤æœºåˆ¶**: åŸºäºç»‘å®šå­—æ®µ(client_id/server_id)çš„è¿‡æ»¤å™¨
- **æ—¥å¿—è·¯ç”±**: loguruçš„handleræœºåˆ¶å®ç°æ—¥å¿—æ–‡ä»¶åˆ†ç¦»

### 2. é€šä¿¡æœºåˆ¶æ¶æ„
- **SimpleCommunicationManager**: å…¨å±€æ¶ˆæ¯ä¸­å¿ƒï¼Œç»´æŠ¤æ¶ˆæ¯é˜Ÿåˆ—
- **æ¶ˆæ¯å¤„ç†å™¨**: ç»„ä»¶æ³¨å†Œæ¶ˆæ¯å¤„ç†å‡½æ•°
- **æ¶ˆæ¯æµ**: å®¢æˆ·ç«¯ â†’ SimpleCommunicationManager â†’ æœåŠ¡å™¨

### 3. çŠ¶æ€ç®¡ç†ä½“ç³»
- **å±‚çº§çŠ¶æ€**: åè°ƒå±‚çŠ¶æ€(ClientLifecycleState) + æ§åˆ¶å±‚çŠ¶æ€(TrainingPhaseState)
- **çŠ¶æ€è½¬æ¢**: ä¸¥æ ¼çš„çŠ¶æ€æœºç®¡ç†ï¼Œæ”¯æŒçŠ¶æ€è½¬æ¢éªŒè¯å’Œå›è°ƒ
- **çŠ¶æ€åŒæ­¥**: å¤šç»„ä»¶çŠ¶æ€åè°ƒå’ŒåŒæ­¥æœºåˆ¶

## ğŸš¨ å¸¸è§é™·é˜±è­¦ç¤º

### âŒ é¿å…çš„é”™è¯¯æ¨¡å¼
1. **æ—¥å¿—å™¨é‡æ–°ç»‘å®š**: å­ç±»ä¸åº”è¦†ç›–åŸºç±»æ­£ç¡®è®¾ç½®çš„æ—¥å¿—å™¨
2. **è¿‡æ»¤å™¨å­—æ®µä¸åŒ¹é…**: filterå‡½æ•°ä¸­çš„å­—æ®µå¿…é¡»ä¸ç»‘å®šå­—æ®µä¸€è‡´
3. **å…¨å±€æ—¥å¿—å™¨è¯¯ç”¨**: é¿å…ç›´æ¥ä½¿ç”¨å…¨å±€loggerè€Œéç»„ä»¶æ—¥å¿—å™¨
4. **å¾ªç¯å¯¼å…¥**: æ³¨æ„æ¨¡å—é—´çš„ä¾èµ–å…³ç³»ï¼Œé¿å…å¾ªç¯å¯¼å…¥

### âœ… æ­£ç¡®çš„è°ƒè¯•æµç¨‹
1. **ç¯å¢ƒéªŒè¯** â†’ **æ—¥å¿—æ£€æŸ¥** â†’ **ç»„ä»¶çŠ¶æ€** â†’ **æ¶ˆæ¯æµè¿½è¸ª**
2. **é—®é¢˜åˆ†ç±»** â†’ **å®šå‘è¯Šæ–­** â†’ **ç²¾ç¡®ä¿®å¤** â†’ **å…¨é¢éªŒè¯**
3. **å•å…ƒæµ‹è¯•** â†’ **é›†æˆæµ‹è¯•** â†’ **ç«¯åˆ°ç«¯éªŒè¯** â†’ **æ€§èƒ½æµ‹è¯•**

## ğŸ“‹ æœªæ¥ç»´æŠ¤æŒ‡å—

### ä»£ç å®¡æŸ¥æ¸…å•
- [ ] æ–°å¢ç»„ä»¶æ˜¯å¦æ­£ç¡®ä½¿ç”¨ç»„ä»¶æ—¥å¿—å™¨
- [ ] æ—¥å¿—è®°å½•æ˜¯å¦ä½¿ç”¨ `self.logger` è€Œéå…¨å±€ `logger`
- [ ] æ–°çš„æ¶ˆæ¯ç±»å‹æ˜¯å¦æ­£ç¡®æ³¨å†Œå¤„ç†å™¨
- [ ] çŠ¶æ€å˜åŒ–æ˜¯å¦æœ‰å®Œæ•´çš„æ—¥å¿—è®°å½•

### æµ‹è¯•éªŒè¯æ¸…å•
- [ ] è¿è¡Œ `uv run python run_tests.py quick`
- [ ] æ£€æŸ¥å®¢æˆ·ç«¯æ—¥å¿—æ–‡ä»¶æ˜¯å¦åŒ…å«æ¶ˆæ¯å‘é€è®°å½•
- [ ] éªŒè¯æœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶æ˜¯å¦åŒ…å«æ³¨å†Œå¤„ç†è®°å½•
- [ ] ç¡®è®¤æ—¥å¿—æ ¼å¼æ ‡è¯†ç¬¦æ­£ç¡®ï¼ˆCLIENT[id]ã€SERVER[id]ï¼‰

### æ€§èƒ½ç›‘æ§å»ºè®®
- [ ] å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶å¤§å°å’Œè½®è½¬
- [ ] ç›‘æ§æ¶ˆæ¯å¤„ç†å»¶è¿Ÿå’Œè¶…æ—¶ç‡
- [ ] è§‚å¯Ÿå†…å­˜ä½¿ç”¨å’Œç»„ä»¶èµ„æºæ¶ˆè€—
- [ ] éªŒè¯çŠ¶æ€è½¬æ¢çš„æ€§èƒ½å’Œç¨³å®šæ€§

---

**ğŸ“ å¤‡æ³¨**: æ­¤æ¬¡è°ƒè¯•æˆåŠŸå»ºç«‹äº†å®Œæ•´çš„å®é™…é€šä¿¡æœºåˆ¶ï¼Œå½»åº•è§£å†³äº†æ—¥å¿—åˆ†ç¦»é—®é¢˜ï¼Œä¸ºåç»­çš„è”é‚¦å­¦ä¹ åŠŸèƒ½å¼€å‘å¥ å®šäº†åšå®åŸºç¡€ã€‚æ‰€æœ‰å…³é”®ç»„ä»¶ç°åœ¨éƒ½èƒ½æ­£ç¡®è®°å½•å’Œè¿½è¸ªæ“ä½œæ—¥å¿—ï¼Œå¤§å¤§æå‡äº†ç³»ç»Ÿçš„å¯è§‚æµ‹æ€§å’Œå¯è°ƒè¯•æ€§ã€‚

# MOE-FedCL è°ƒè¯•å·¥å…·å¿«é€Ÿå‚è€ƒ

## ğŸš€ å¿«é€Ÿå¯åŠ¨

```bash
# æ—¥å¸¸å¿«é€Ÿæ£€æŸ¥ï¼ˆæ¨èï¼‰
./scripts/simple_debug.sh quick_diagnose

# å®Œæ•´äº¤äº’å¼èœå•
./scripts/debug_tools.sh

# ç´§æ€¥åœæ­¢æ‰€æœ‰å¾ªç¯
./scripts/debug_tools.sh emergency_stop
```

## ğŸ“‹ å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥

| ç›®çš„ | å‘½ä»¤ | è¯´æ˜ |
|------|------|------|
| å¿«é€Ÿè¯Šæ–­ | `./scripts/simple_debug.sh quick_diagnose` | æ—¥å¸¸æ£€æŸ¥æ¨è |
| ç³»ç»Ÿè¯Šæ–­ | `./scripts/debug_tools.sh fedcl_diagnose` | è¯¦ç»†ç³»ç»ŸçŠ¶æ€ |
| åˆ†æWarning | `./scripts/debug_tools.sh analyze_warning_details` | Warningè¯¦ç»†åˆ†æ |
| åˆ†æé˜»å¡ | `./scripts/debug_tools.sh analyze_blocking_root_cause` | é˜»å¡æ ¹æœ¬åŸå›  |
| æŸ¥çœ‹æ—¥å¿— | `./scripts/simple_debug.sh show_log_summary` | æ—¥å¿—æ‘˜è¦ |
| æ¸…ç†è¿›ç¨‹ | `./scripts/debug_tools.sh kill_test_processes` | æ¸…ç†æµ‹è¯•è¿›ç¨‹ |
| ç´§æ€¥åœæ­¢ | `./scripts/debug_tools.sh emergency_stop` | åœæ­¢æ‰€æœ‰å¾ªç¯ |

## ğŸ†˜ ç´§æ€¥æƒ…å†µå¤„ç†

```bash
# 1. ç»ˆç«¯å¾ªç¯è¾“å‡ºä¸åœ
Ctrl+C  # æˆ–è€…è¾“å…¥ 'q'

# 2. è¿›ç¨‹æ— æ³•æ¸…ç†
./scripts/debug_tools.sh emergency_stop

# 3. è„šæœ¬æ— æƒé™
chmod +x ./scripts/*.sh

# 4. å¼ºåˆ¶æ€æ­»è¿›ç¨‹
ps aux | grep pytest
kill -9 <pid>
```

## ğŸ” æ•…éšœè¯Šæ–­æµç¨‹

```
1. å¿«é€Ÿè¯Šæ–­     â†’ ./scripts/simple_debug.sh quick_diagnose
2. ç³»ç»Ÿè¯¦ç»†è¯Šæ–­ â†’ ./scripts/debug_tools.sh fedcl_diagnose  
3. Warningåˆ†æ  â†’ ./scripts/debug_tools.sh analyze_warning_details
4. é˜»å¡åˆ†æ     â†’ ./scripts/debug_tools.sh analyze_blocking_root_cause
5. æ¸…ç†è¿›ç¨‹     â†’ ./scripts/debug_tools.sh kill_test_processes
```

## ğŸ“Š æ—¥å¿—æ–‡ä»¶ä½ç½®

```
logs/experiment_YYYYMMDD_HHMMSS/
â”œâ”€â”€ federated_training.log     # ä¸»è¦æ—¥å¿—
â”œâ”€â”€ server_test_server.log     # æœåŠ¡å™¨æ—¥å¿—  
â””â”€â”€ clients/client_*.log       # å®¢æˆ·ç«¯æ—¥å¿—
```

## âš ï¸ æ³¨æ„äº‹é¡¹

- ğŸŸ¢ **æ¨è**: æ—¥å¸¸ä½¿ç”¨ `simple_debug.sh`
- ğŸŸ¡ **è°¨æ…**: å®æ—¶ç›‘æ§åŠŸèƒ½é¿å…é•¿æ—¶é—´è¿è¡Œ
- ğŸ”´ **è®°ä½**: Ctrl+C å’Œ emergency_stop æ˜¯å®‰å…¨å‡ºå£
