# è£…é¥°å™¨ç³»ç»Ÿé›†æˆåˆ°æ–°æ¶æ„çš„æ–¹æ¡ˆ

## 1. è£…é¥°å™¨ç³»ç»Ÿæ¦‚è¿° âœ… å·²éªŒè¯

**é¡¹ç›®å·²ç»å…·å¤‡å®Œæ•´çš„è£…é¥°å™¨ç³»ç»Ÿ**ï¼Œæ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ç»„ä»¶ï¼š

### æ ¸å¿ƒè£…é¥°å™¨ âœ… å·²å®ç°
- `@fedcl.learner(name, **metadata)`: æ³¨å†Œè‡ªå®šä¹‰å­¦ä¹ å™¨
- `@fedcl.aggregator(name, **metadata)`: æ³¨å†Œè‡ªå®šä¹‰èšåˆå™¨  
- `@fedcl.evaluator(name, **metadata)`: æ³¨å†Œè‡ªå®šä¹‰è¯„ä¼°å™¨
- `@fedcl.trainer(name, **metadata)`: æ³¨å†Œè‡ªå®šä¹‰è”é‚¦è®­ç»ƒå™¨

### ç»„ä»¶æ³¨å†Œæœºåˆ¶ âœ… å·²å®ç°
- å…¨å±€`ComponentRegistry`å®ä¾‹ï¼š`fedcl.registry.registry`
- è‡ªåŠ¨å…ƒæ•°æ®ç®¡ç†ï¼ˆ_fedcl_name, _fedcl_type, _fedcl_metadataï¼‰
- è¿è¡Œæ—¶ç»„ä»¶æŸ¥æ‰¾å’Œå®ä¾‹åŒ–ï¼š`registry.get_learner(name)`
- è£…é¥°å™¨æ–‡ä»¶ï¼š`fedcl/api/decorators.py`
- æ³¨å†Œè¡¨æ–‡ä»¶ï¼š`fedcl/registry/__init__.py`

## 2. æ–°æ¶æ„é›†æˆç­–ç•¥ ğŸ”„ æ­£åœ¨å®æ–½

### 2.1 æ‰§è¡Œå™¨å±‚é›†æˆ ğŸ”„ æ­£åœ¨è¿›è¡Œ

**ç›®æ ‡**ï¼šæ‰§è¡Œå™¨éœ€è¦æ”¯æŒä»æ³¨å†Œè¡¨è·å–ç”¨æˆ·è‡ªå®šä¹‰çš„learner

**å®æ–½æ–¹æ¡ˆ**ï¼š
```python
# fedcl/execution/local/local_executor.py (æ›´æ–°å)
from ...registry import registry

class LocalExecutor:
    def _create_learner(self, client_id: str) -> AbstractLearner:
        """
        ä»æ³¨å†Œè¡¨æˆ–å†…ç½®å®ç°åˆ›å»ºlearnerå®ä¾‹
        
        ä¼˜å…ˆçº§ï¼š
        1. æ³¨å†Œè¡¨ä¸­çš„ç”¨æˆ·è‡ªå®šä¹‰learner
        2. å†…ç½®StandardLearner
        """
        learner_name = self.config.get("learner_name")
        learner_type = self.config.get("learner_type", "standard")
        
        # ä¼˜å…ˆä»æ³¨å†Œè¡¨è·å–ç”¨æˆ·è‡ªå®šä¹‰learner
        if learner_name and learner_name in registry.learners:
            learner_cls = registry.get_learner(learner_name)
            return learner_cls(client_id, self.config)
        
        # å›é€€åˆ°å†…ç½®learner
        if learner_type == "standard":
            return StandardLearner(client_id, self.config)
        else:
            raise ValueError(f"Unknown learner type: {learner_type}")
```

**çŠ¶æ€**ï¼šâœ… LocalExecutorå·²æ·»åŠ registryå¯¼å…¥ï¼Œæ­£åœ¨ä¿®æ”¹_create_learneræ–¹æ³•

### 2.2 é…ç½®é©±åŠ¨çš„ç»„ä»¶é€‰æ‹©

æ”¯æŒé€šè¿‡é…ç½®æ–‡ä»¶æŒ‡å®šç”¨æˆ·è‡ªå®šä¹‰ç»„ä»¶ï¼š

```yaml
# é…ç½®æ–‡ä»¶ç¤ºä¾‹
federation:
  learner_name: "my_continual_learner"  # ä»æ³¨å†Œè¡¨è·å–
  aggregator_name: "my_weighted_avg"    # ä»æ³¨å†Œè¡¨è·å–
  trainer_name: "diffusion_trainer"     # ä»æ³¨å†Œè¡¨è·å–
  
  # æˆ–è€…ä½¿ç”¨å†…ç½®ç»„ä»¶
  learner_type: "standard"              # å†…ç½®å®ç°
  aggregator_type: "fedavg"            # å†…ç½®å®ç°
```

### 2.3 learner_proxy é€æ˜è°ƒç”¨

learnerä»£ç†æ”¯æŒè°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰learnerçš„ä»»æ„æ–¹æ³•ï¼š

```python
# fedcl/proxy/learner_proxy.py (å¢å¼ºå)
class LearnerProxy:
    async def execute_remote_method(
        self, 
        client_id: str, 
        method_name: str, 
        *args, 
        **kwargs
    ) -> Any:
        """
        æ‰§è¡Œè¿œç¨‹learneræ–¹æ³• - æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ–¹æ³•
        
        ç”¨æˆ·è‡ªå®šä¹‰learnerå¯èƒ½æœ‰ä¸åŒçš„æ–¹æ³•åï¼š
        - train_task, train_on_client, train_epoch
        - evaluate_task, evaluate  
        - ä»»æ„è‡ªå®šä¹‰æ–¹æ³•
        """
        executor = self._get_executor_for_client(client_id)
        return await executor.execute_method(client_id, method_name, *args, **kwargs)
    
    # å…¼å®¹æ€§æ–¹æ³• - è‡ªåŠ¨æ˜ å°„åˆ°ç”¨æˆ·å®é™…æ–¹æ³•
    async def train_epoch(self, client_id: str, **kwargs) -> Dict[str, Any]:
        """è®­ç»ƒæ¥å£ - è‡ªåŠ¨é€‚é…ç”¨æˆ·æ–¹æ³•å"""
        # æ£€æµ‹ç”¨æˆ·learnerçš„å®é™…æ–¹æ³•å
        learner_methods = await self._get_learner_methods(client_id)
        
        if "train_task" in learner_methods:
            return await self.execute_remote_method(client_id, "train_task", **kwargs)
        elif "train_on_client" in learner_methods:
            return await self.execute_remote_method(client_id, "train_on_client", **kwargs)
        else:
            return await self.execute_remote_method(client_id, "train_epoch", **kwargs)
```

## 3. ç”¨æˆ·ä½“éªŒç¤ºä¾‹

ç”¨æˆ·å¯ä»¥å®Œå…¨é€æ˜åœ°ä½¿ç”¨è‡ªå®šä¹‰ç»„ä»¶ï¼š

```python
# ç”¨æˆ·å®šä¹‰è‡ªå®šä¹‰learner
@fedcl.learner("my_continual_learner")
class MyContinualLearner:
    def __init__(self, client_id, config):
        self.client_id = client_id
        self.config = config
        # ç”¨æˆ·çš„åˆå§‹åŒ–é€»è¾‘
        
    def train_task(self, task_data, **kwargs):
        # ç”¨æˆ·çš„è®­ç»ƒé€»è¾‘
        return {"accuracy": 0.95, "loss": 0.1}
        
    def evaluate_task(self, task_data, **kwargs):
        # ç”¨æˆ·çš„è¯„ä¼°é€»è¾‘
        return {"accuracy": 0.93}

# ç”¨æˆ·å®šä¹‰è‡ªå®šä¹‰trainer  
@fedcl.trainer("my_fedavg")
class MyFedAvgTrainer(AbstractFederationTrainer):
    async def train(self):
        for round_num in range(self.config.num_rounds):
            # ç”¨æˆ·çš„è”é‚¦è®­ç»ƒé€»è¾‘
            # learner_proxyä¼šè‡ªåŠ¨è°ƒç”¨ç”¨æˆ·çš„train_taskæ–¹æ³•
            results = await asyncio.gather(*[
                self.learner_proxy.train_epoch(client_id, round_num=round_num)
                for client_id in self.selected_clients
            ])
            
            # èšåˆé€»è¾‘
            weights = await self.aggregate_weights(results)

# é…ç½®æ–‡ä»¶ - æŒ‡å®šä½¿ç”¨ç”¨æˆ·ç»„ä»¶
# config.yaml:
federation:
  learner_name: "my_continual_learner"
  trainer_name: "my_fedavg"
  
# å¯åŠ¨ - æ¡†æ¶è‡ªåŠ¨ä½¿ç”¨ç”¨æˆ·ç»„ä»¶
trainer = get_trainer_from_config("config.yaml")
results = await trainer.train()
```

## 4. å®æ–½è®¡åˆ’æ›´æ–° ğŸ“‹ å·²åŒæ­¥åˆ°ä»»åŠ¡ç®¡ç†

### é›†æˆä»»åŠ¡çŠ¶æ€
- [ğŸ”„] **æ›´æ–°æ‰§è¡Œå™¨æ”¯æŒæ³¨å†Œè¡¨**: ä¿®æ”¹LocalExecutorã€PseudoExecutorã€DistributedExecutor
  - âœ… LocalExecutor - æ­£åœ¨ä¿®æ”¹
  - â³ PseudoExecutor - å¾…ä¿®æ”¹
  - â³ DistributedExecutor - å¾…ä¿®æ”¹
- [â³] **å¢å¼ºlearner_proxy**: æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰æ–¹æ³•çš„è‡ªåŠ¨æ˜ å°„
- [â³] **é…ç½®ç³»ç»Ÿé›†æˆ**: æ”¯æŒlearner_nameã€aggregator_nameç­‰é…ç½®é¡¹  
- [â³] **å‘åå…¼å®¹æ€§æµ‹è¯•**: ç¡®ä¿å†…ç½®ç»„ä»¶ä»å¯æ­£å¸¸å·¥ä½œ
- [â³] **ç”¨æˆ·ç»„ä»¶é›†æˆæµ‹è¯•**: éªŒè¯è£…é¥°å™¨æ³¨å†Œçš„ç»„ä»¶å¯æ­£ç¡®è°ƒç”¨

### ä¿®æ”¹ä¼˜å…ˆçº§
1. **ğŸ”¥ é«˜ä¼˜å…ˆçº§**: æ‰§è¡Œå™¨æ”¯æŒæ³¨å†Œè¡¨ï¼ˆå½±å“æ ¸å¿ƒåŠŸèƒ½ï¼‰
2. **âš¡ ä¸­ä¼˜å…ˆçº§**: learner_proxyæ–¹æ³•æ˜ å°„ï¼ˆå½±å“ç”¨æˆ·ä½“éªŒï¼‰
3. **âœ¨ ä½ä¼˜å…ˆçº§**: é…ç½®ç³»ç»Ÿä¼˜åŒ–ï¼ˆé”¦ä¸Šæ·»èŠ±ï¼‰

### ä»»åŠ¡ç®¡ç†é›†æˆ
æ‰€æœ‰è£…é¥°å™¨é›†æˆä»»åŠ¡å·²æ·»åŠ åˆ°é¡¹ç›®ä»»åŠ¡ç®¡ç†ç³»ç»Ÿï¼Œå½“å‰æ­£åœ¨æ‰§è¡Œexecutor_registry_supportä»»åŠ¡ã€‚

## 5. æ¶æ„ä¼˜åŠ¿

### çœŸæ­£çš„é›¶æ¦‚å¿µæš´éœ²
```python
# ç”¨æˆ·ä»£ç  - å®Œå…¨æ„ŸçŸ¥ä¸åˆ°è”é‚¦å­¦ä¹ å¤æ‚æ€§
@fedcl.learner("my_learner")
class MyLearner:
    def train_task(self, data):
        # å°±åƒå†™æ™®é€šçš„æœºå™¨å­¦ä¹ ä»£ç 
        for batch in data:
            # è®­ç»ƒé€»è¾‘
            pass
        return results

# æ¡†æ¶è‡ªåŠ¨å¤„ç†ï¼š
# 1. è¿œç¨‹è°ƒç”¨ï¼ˆæœ¬åœ°/è¿›ç¨‹/ç½‘ç»œï¼‰
# 2. å‚æ•°åºåˆ—åŒ–/ååºåˆ—åŒ–  
# 3. é”™è¯¯å¤„ç†å’Œé‡è¯•
# 4. æ¨¡å¼åˆ‡æ¢ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰
```

### å®Œå…¨çš„é€æ˜åŒ–
- ç”¨æˆ·å®šä¹‰çš„learner.train_task() æ–¹æ³•ä¼šè¢«æ¡†æ¶é€æ˜åœ°è°ƒç”¨
- æ— è®ºæ˜¯æœ¬åœ°ã€å¤šè¿›ç¨‹è¿˜æ˜¯ç½‘ç»œæ¨¡å¼ï¼Œè°ƒç”¨æ–¹å¼å®Œå…¨ä¸€è‡´
- ç”¨æˆ·æ— éœ€äº†è§£ä»»ä½•åˆ†å¸ƒå¼ç³»ç»Ÿç»†èŠ‚

è¿™ç§é›†æˆæ–¹æ¡ˆçœŸæ­£å®ç°äº†é¡¹ç›®è§„èŒƒä¸­çš„"ç”¨æˆ·åªéœ€å…³å¿ƒè”é‚¦å­¦ä¹ ç®—æ³•é€»è¾‘ï¼Œæ— éœ€äº†è§£åˆ†å¸ƒå¼ç»†èŠ‚"çš„ç›®æ ‡ï¼