# MOE-FedCL 调试工具使用指南

## 📖 概述

本文档介绍 MOE-FedCL 项目中的调试工具集，包括 `debug_tools.sh` 和 `simple_debug.sh` 两个脚本，专为联邦学习系统的调试和故障排除而设计。

## 🔧 工具概览

### 1. `debug_tools.sh` - 完整调试工具集
- **功能**: 全面的调试和监控功能
- **特点**: 支持实时监控、深度分析、循环检查
- **适用**: 深度调试、实时监控、问题诊断

### 2. `simple_debug.sh` - 简化调试工具
- **功能**: 基础的一次性检查功能
- **特点**: 无循环输出、快速诊断、安全可靠
- **适用**: 日常检查、快速诊断、避免终端阻塞

## 📋 功能对比表

| 功能 | debug_tools.sh | simple_debug.sh | 说明 |
|------|----------------|-----------------|------|
| 系统诊断 | ✅ 详细 | ✅ 快速 | 分析日志和组件状态 |
| 进程监控 | ✅ 实时循环 | ✅ 单次检查 | 检查测试进程状态 |
| 日志分析 | ✅ 深度分析 | ✅ 摘要查看 | 分析错误和警告 |
| Warning分析 | ✅ | ❌ | 详细分析警告原因 |
| 阻塞分析 | ✅ | ❌ | 深度分析测试阻塞 |
| 进程清理 | ✅ | ✅ | 强制清理进程 |
| 超时测试 | ✅ | ❌ | 带超时的测试运行 |
| 日志监控 | ✅ 实时 | ❌ | 实时监控日志变化 |
| 紧急停止 | ✅ | ❌ | 停止所有循环进程 |

## 🚀 使用方法

### debug_tools.sh 使用说明

#### 1. 交互式菜单模式
```bash
# 启动交互式菜单
./scripts/debug_tools.sh

# 选择对应功能的数字即可
1. 系统诊断
2. 实时监控测试进程
3. 分析测试日志
4. 运行带超时的测试
5. 杀死所有测试进程
6. 监控日志文件变化
7. 详细分析Warning原因
8. 分析测试阻塞根本原因
9. 紧急停止所有调试脚本
0. 退出
```

#### 2. 直接命令模式
```bash
# 系统诊断
./scripts/debug_tools.sh fedcl_diagnose

# 分析Warning详情
./scripts/debug_tools.sh analyze_warning_details

# 分析阻塞根本原因
./scripts/debug_tools.sh analyze_blocking_root_cause

# 监控测试进程（实时）
./scripts/debug_tools.sh monitor_test_processes

# 清理测试进程
./scripts/debug_tools.sh kill_test_processes

# 紧急停止所有循环
./scripts/debug_tools.sh emergency_stop
```

### simple_debug.sh 使用说明

#### 1. 交互式菜单模式
```bash
# 启动简化菜单
./scripts/simple_debug.sh

# 选择功能
1. 快速系统诊断
2. 查看日志摘要
3. 检查进程状态（单次）
4. 清理所有进程
0. 退出
```

#### 2. 直接命令模式
```bash
# 快速诊断
./scripts/simple_debug.sh quick_diagnose

# 查看日志摘要
./scripts/simple_debug.sh show_log_summary

# 单次进程检查
./scripts/simple_debug.sh check_processes_once

# 清理所有进程
./scripts/simple_debug.sh cleanup_all
```

## 🎯 主要功能详解

### 1. 系统诊断 (fedcl_diagnose)
**功能**: 分析联邦学习系统的整体状态
```bash
./scripts/debug_tools.sh fedcl_diagnose
```
**输出内容**:
- 最新实验日志目录
- 错误和警告统计
- 组件状态（通信组件、客户端、服务器）
- 最近的错误信息

### 2. Warning详细分析 (analyze_warning_details)
**功能**: 深度分析日志中的警告信息
```bash
./scripts/debug_tools.sh analyze_warning_details
```
**分析内容**:
- 所有警告信息汇总
- 轮次超时警告详细分析
- 客户端训练活动检查
- 问题根本原因分析
- 解决建议

### 3. 阻塞分析 (analyze_blocking_root_cause)
**功能**: 分析集成测试阻塞的根本原因
```bash
./scripts/debug_tools.sh analyze_blocking_root_cause
```
**分析内容**:
- 当前活跃进程检查
- 心跳线程无限循环问题
- 线程清理不彻底问题
- 测试框架问题分析
- 状态同步问题
- 解决方案建议

### 4. 实时监控 (monitor_test_processes)
**功能**: 实时监控测试进程状态
```bash
./scripts/debug_tools.sh monitor_test_processes
```
**监控内容**:
- Pytest 进程状态
- Python 测试进程状态
- 内存使用情况
- 自动退出条件（连续3次无进程）

**安全机制**:
- Ctrl+C 信号处理
- 输入 'q' 或 'quit' 退出
- 自动超时退出

### 5. 日志监控 (monitor_logs)
**功能**: 实时监控日志文件变化
```bash
./scripts/debug_tools.sh monitor_logs
```
**特点**:
- 监控所有相关日志文件
- 限制显示最新20行
- 60秒自动超时
- Ctrl+C 安全退出

### 6. 超时测试 (timeout_test)
**功能**: 运行带超时保护的测试
```bash
./scripts/debug_tools.sh timeout_test
```
**使用流程**:
1. 输入超时时间（默认30秒）
2. 输入测试命令
3. 自动执行并监控超时

### 7. 进程清理功能
**普通清理**:
```bash
./scripts/debug_tools.sh kill_test_processes
```

**紧急停止**:
```bash
./scripts/debug_tools.sh emergency_stop
```

## 🛡️ 安全机制

### 1. 循环控制
- **信号处理**: 支持 Ctrl+C 安全退出
- **超时机制**: 自动超时退出循环
- **用户输入**: 支持 'q' 命令退出
- **自动退出**: 满足条件时自动退出

### 2. 进程管理
- **温和终止**: 先使用 TERM 信号
- **强制终止**: 延时后使用 KILL 信号
- **进程检查**: 确认进程状态
- **清理验证**: 验证清理效果

### 3. 错误处理
- **文件检查**: 检查日志文件存在性
- **权限验证**: 检查脚本执行权限
- **路径处理**: 使用绝对路径避免错误

## 🔍 故障排除

### 常见问题及解决方案

#### 1. 终端循环输出不停
**问题**: 监控功能导致终端持续输出
**解决方案**:
```bash
# 方法1: 按 Ctrl+C
# 方法2: 输入 'q' 退出
# 方法3: 紧急停止
./scripts/debug_tools.sh emergency_stop
```

#### 2. 测试进程无法清理
**问题**: kill_test_processes 无效
**解决方案**:
```bash
# 使用紧急停止
./scripts/debug_tools.sh emergency_stop

# 或者手动查找并清理
ps aux | grep pytest
kill -9 <pid>
```

#### 3. 权限问题
**问题**: 脚本无法执行
**解决方案**:
```bash
# 添加执行权限
chmod +x ./scripts/debug_tools.sh
chmod +x ./scripts/simple_debug.sh
```

#### 4. 日志目录不存在
**问题**: 未找到实验日志目录
**解决方案**:
```bash
# 检查logs目录
ls -la logs/

# 运行一次测试生成日志
python -m pytest tests/test_federation_framework_fixed.py -v -s
```

## 📊 使用建议

### 1. 日常使用推荐
```bash
# 推荐：日常快速检查
./scripts/simple_debug.sh quick_diagnose

# 推荐：查看日志摘要
./scripts/simple_debug.sh show_log_summary
```

### 2. 深度调试推荐
```bash
# 系统问题诊断
./scripts/debug_tools.sh fedcl_diagnose

# Warning详细分析
./scripts/debug_tools.sh analyze_warning_details

# 阻塞问题分析
./scripts/debug_tools.sh analyze_blocking_root_cause
```

### 3. 实时监控推荐
```bash
# 监控测试进程（短期）
./scripts/debug_tools.sh monitor_test_processes

# 监控日志变化（短期）
./scripts/debug_tools.sh monitor_logs
```

## 🔧 自定义扩展

### 添加新功能
1. 在相应脚本中添加函数
2. 在菜单中添加选项
3. 在main函数中添加case分支

### 修改超时时间
```bash
# 修改日志监控超时（默认60秒）
# 在 monitor_logs 函数中修改
timeout 120 tail -n 20 -f ...

# 修改进程监控自动退出条件（默认3次）
# 在 monitor_test_processes 函数中修改
if [[ $count -gt 5 ]]; then
```

## 📝 日志文件说明

### 日志目录结构
```
logs/
└── experiment_YYYYMMDD_HHMMSS/
    ├── federated_training.log     # 主要训练日志
    ├── server_test_server.log     # 服务器日志
    └── clients/
        ├── client_0.log           # 客户端0日志
        ├── client_1.log           # 客户端1日志
        └── client_2.log           # 客户端2日志
```

### 重要日志内容
- **ERROR**: 系统错误，需要关注
- **WARNING**: 警告信息，通常是超时等预期行为
- **heartbeat**: 心跳消息，用于检查连接状态
- **registration**: 客户端注册消息
- **Round timeout**: 轮次超时，正常的联邦学习行为

## 🎯 总结

1. **日常使用**: 优先使用 `simple_debug.sh` 进行快速检查
2. **深度调试**: 使用 `debug_tools.sh` 的专项分析功能
3. **实时监控**: 短期使用实时监控功能，避免长时间运行
4. **安全退出**: 始终记住 Ctrl+C 和 emergency_stop 功能
5. **问题诊断**: 按照系统诊断 → Warning分析 → 阻塞分析的顺序进行

通过合理使用这些调试工具，可以有效地诊断和解决 MOE-FedCL 联邦学习系统中的各种问题。
