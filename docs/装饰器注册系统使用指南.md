# MOE-FedCL è£…é¥°å™¨æ³¨å†Œç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ“– æ¦‚è¿°

MOE-FedCL æä¾›äº†ä¸€å¥—å¼ºå¤§çš„è£…é¥°å™¨æ³¨å†Œç³»ç»Ÿï¼Œè®©ç”¨æˆ·å¯ä»¥é€šè¿‡ç®€å•çš„è£…é¥°å™¨æ³¨å†Œè‡ªå®šä¹‰ç»„ä»¶ï¼Œæ¡†æ¶ä¼šè‡ªåŠ¨å‘ç°å’Œç®¡ç†è¿™äº›ç»„ä»¶ã€‚

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

- **ğŸ·ï¸ è£…é¥°å™¨æ³¨å†Œ**ï¼šé€šè¿‡ `@learner`ã€`@trainer`ã€`@aggregator`ã€`@evaluator` è£…é¥°å™¨æ³¨å†Œç»„ä»¶
- **ğŸ” è‡ªåŠ¨å‘ç°**ï¼šæ¡†æ¶å¯ä»¥è‡ªåŠ¨æ‰«æå’Œå‘ç°ç”¨æˆ·å®šä¹‰çš„ç»„ä»¶
- **ğŸ“Š å…ƒæ•°æ®ç®¡ç†**ï¼šæ”¯æŒç‰ˆæœ¬ã€ä½œè€…ã€æè¿°ç­‰ä¸°å¯Œçš„å…ƒæ•°æ®
- **ğŸ›¡ï¸ ç±»å‹éªŒè¯**ï¼šè‡ªåŠ¨éªŒè¯ç»„ä»¶æ˜¯å¦ç»§æ‰¿äº†æ­£ç¡®çš„åŸºç±»
- **ğŸ“‹ ç»Ÿä¸€ç®¡ç†**ï¼šå…¨å±€æ³¨å†Œè¡¨ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ç»„ä»¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. æ³¨å†Œå­¦ä¹ å™¨

```python
from fedcl.api import learner
from fedcl.learner.base_learner import BaseLearner

@learner('MyLearner', 
         description='æˆ‘çš„è‡ªå®šä¹‰å­¦ä¹ å™¨',
         version='1.0',
         author='å¼ ä¸‰',
         dataset='MNIST')
class MyLearner(BaseLearner):
    def __init__(self, client_id: str, config: dict, logger=None):
        super().__init__(client_id, config, logger)
        # æ‚¨çš„åˆå§‹åŒ–ä»£ç 
    
    async def train(self, request):
        # æ‚¨çš„è®­ç»ƒé€»è¾‘
        return {'success': True, 'loss': 0.5}
    
    async def evaluate(self, model_data=None):
        # æ‚¨çš„è¯„ä¼°é€»è¾‘
        return {'accuracy': 0.85}
    
    async def get_local_model(self):
        # è¿”å›æœ¬åœ°æ¨¡å‹
        return self.model_params
    
    async def set_local_model(self, model_data):
        # è®¾ç½®æœ¬åœ°æ¨¡å‹
        self.model_params = model_data
        return True
```

### 2. æ³¨å†Œè®­ç»ƒå™¨

```python
from fedcl.api import trainer
from fedcl.trainer.base_trainer import BaseTrainer

@trainer('MyTrainer', 
         description='æˆ‘çš„è”é‚¦è®­ç»ƒå™¨',
         version='1.0',
         author='æå››',
         algorithms=['fedavg', 'custom'])
class MyTrainer(BaseTrainer):
    def __init__(self, config=None):
        super().__init__(config or {})
        # æ‚¨çš„åˆå§‹åŒ–ä»£ç 
    
    async def train_round(self, round_num: int, client_ids: list):
        # å®ç°è®­ç»ƒè½®æ¬¡é€»è¾‘
        return {'round': round_num, 'success': True}
    
    async def aggregate_models(self, client_results):
        # å®ç°æ¨¡å‹èšåˆé€»è¾‘
        return {'aggregated': True}
    
    async def evaluate_global_model(self):
        # å®ç°å…¨å±€æ¨¡å‹è¯„ä¼°
        return {'accuracy': 0.90}
    
    def should_stop_training(self, round_num, round_result):
        # å®ç°åœæ­¢æ¡ä»¶
        return round_num >= 10
```

### 3. æ³¨å†Œèšåˆå™¨

```python
from fedcl.api import aggregator

@aggregator('MyAggregator', 
           description='æˆ‘çš„èšåˆç®—æ³•',
           version='1.0',
           author='ç‹äº”',
           algorithm='weighted_avg')
class MyAggregator:
    def __init__(self, config=None):
        self.config = config or {}
    
    def aggregate(self, client_models, weights=None):
        # æ‚¨çš„èšåˆé€»è¾‘
        return {'aggregated_model': {}}
```

### 4. æ³¨å†Œè¯„ä¼°å™¨

```python
from fedcl.api import evaluator

@evaluator('MyEvaluator', 
          description='æˆ‘çš„è¯„ä¼°æŒ‡æ ‡',
          version='1.0',
          author='èµµå…­',
          metrics=['accuracy', 'f1'])
class MyEvaluator:
    def __init__(self, config=None):
        self.config = config or {}
    
    def evaluate(self, predictions, ground_truth):
        # æ‚¨çš„è¯„ä¼°é€»è¾‘
        return {'accuracy': 0.85, 'f1': 0.82}
```

## ğŸ”§ ä½¿ç”¨æ³¨å†Œçš„ç»„ä»¶

### è·å–å’Œå®ä¾‹åŒ–ç»„ä»¶

```python
from fedcl.registry import registry

# è·å–å­¦ä¹ å™¨ç±»
learner_cls = registry.get_learner('MyLearner')
learner = learner_cls('client_1', {})

# è·å–è®­ç»ƒå™¨ç±»  
trainer_cls = registry.get_trainer('MyTrainer')
trainer = trainer_cls()

# è·å–èšåˆå™¨ç±»
aggregator_cls = registry.get_aggregator('MyAggregator')
aggregator = aggregator_cls()

# è·å–è¯„ä¼°å™¨ç±»
evaluator_cls = registry.get_evaluator('MyEvaluator')
evaluator = evaluator_cls()
```

### æŸ¥çœ‹å·²æ³¨å†Œçš„ç»„ä»¶

```python
from fedcl.api.discovery import list_registered_components

# æŸ¥çœ‹æ‰€æœ‰å·²æ³¨å†Œçš„ç»„ä»¶
components = list_registered_components()
print(components)

# æŸ¥çœ‹ç‰¹å®šç±»å‹çš„ç»„ä»¶
learners = list_registered_components('learner')
print(learners)

# æŸ¥çœ‹æ³¨å†Œè¡¨ç»Ÿè®¡
from fedcl.registry import registry
stats = registry.get_component_count()
print(f"å·²æ³¨å†Œç»„ä»¶ç»Ÿè®¡: {stats}")
```

## ğŸ” è‡ªåŠ¨å‘ç°åŠŸèƒ½

### ä»ç›®å½•è‡ªåŠ¨å‘ç°

```python
from fedcl.api.discovery import auto_discover_components

# ä»å½“å‰ç›®å½•å‘ç°ç»„ä»¶
discovered = auto_discover_components(['.'])

# ä»ç‰¹å®šç›®å½•é€’å½’å‘ç°
discovered = auto_discover_components(['/path/to/your/components'], recursive=True)

# åªå‘ç°ç‰¹å®šç±»å‹çš„ç»„ä»¶
discovered = auto_discover_components(['.'], component_types=['learner', 'trainer'])
```

### ä»æ¨¡å—æ³¨å†Œ

```python
from fedcl.api.discovery import register_from_module, register_from_package

# ä»å•ä¸ªæ¨¡å—æ³¨å†Œ
register_from_module('my_components.learners')

# ä»æ•´ä¸ªåŒ…æ³¨å†Œ
register_from_package('my_components', recursive=True)
```

## ğŸ“ æœ€ä½³å®è·µ

### 1. å‘½åè§„èŒƒ

- **ç»„ä»¶åç§°**ï¼šä½¿ç”¨æ¸…æ™°ã€æè¿°æ€§çš„åç§°ï¼Œå¦‚ `MNISTLearner`ã€`FedAvgTrainer`
- **ç‰ˆæœ¬å·**ï¼šä½¿ç”¨è¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œå¦‚ `1.0.0`ã€`2.1.3`
- **æè¿°**ï¼šæä¾›æ¸…æ™°çš„åŠŸèƒ½æè¿°

### 2. å…ƒæ•°æ®ç®¡ç†

```python
@learner('AdvancedLearner',
         description='åŸºäºæ·±åº¦å­¦ä¹ çš„é«˜çº§å­¦ä¹ å™¨',
         version='2.1.0',
         author='å›¢é˜Ÿåç§°',
         dataset='ImageNet',
         framework='PyTorch',
         requires=['torch>=1.9.0', 'torchvision>=0.10.0'])
class AdvancedLearner(BaseLearner):
    pass
```

### 3. ç»§æ‰¿æ£€æŸ¥

è£…é¥°å™¨ä¼šè‡ªåŠ¨æ£€æŸ¥æ‚¨çš„ç±»æ˜¯å¦ç»§æ‰¿äº†æ­£ç¡®çš„åŸºç±»ï¼š

- `@learner` â†’ `BaseLearner`
- `@trainer` â†’ `BaseTrainer`
- `@aggregator` â†’ æ— å¼ºåˆ¶è¦æ±‚
- `@evaluator` â†’ æ— å¼ºåˆ¶è¦æ±‚

### 4. ç»„ä»¶ç»„ç»‡

å»ºè®®æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡æ‚¨çš„ç»„ä»¶ï¼š

```
my_project/
â”œâ”€â”€ learners/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ mnist_learner.py
â”‚   â””â”€â”€ cifar_learner.py
â”œâ”€â”€ trainers/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ custom_trainer.py
â”œâ”€â”€ aggregators/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ weighted_avg.py
â””â”€â”€ evaluators/
    â”œâ”€â”€ __init__.py
    â””â”€â”€ metrics.py
```

## ğŸ› ï¸ é«˜çº§åŠŸèƒ½

### 1. æ¡ä»¶æ³¨å†Œ

```python
import os

# åªåœ¨ç‰¹å®šç¯å¢ƒä¸‹æ³¨å†Œ
if os.getenv('ENABLE_EXPERIMENTAL') == 'true':
    @learner('ExperimentalLearner')
    class ExperimentalLearner(BaseLearner):
        pass
```

### 2. åŠ¨æ€å…ƒæ•°æ®

```python
import platform

@learner('PlatformLearner',
         version='1.0',
         platform=platform.system(),
         python_version=platform.python_version())
class PlatformLearner(BaseLearner):
    pass
```

### 3. ç»„ä»¶æ³¨é”€

```python
from fedcl.registry import registry

# æ³¨é”€ç‰¹å®šç»„ä»¶
registry.unregister_component('MyLearner', 'learner')

# æ¸…ç©ºæ•´ä¸ªæ³¨å†Œè¡¨
from fedcl.api.discovery import clear_registry
clear_registry()  # æ¸…ç©ºæ‰€æœ‰
clear_registry('learner')  # åªæ¸…ç©ºå­¦ä¹ å™¨
```

## ğŸ”§ é›†æˆåˆ°è”é‚¦å­¦ä¹ ç³»ç»Ÿ

### åœ¨FederationServerä¸­ä½¿ç”¨

```python
from fedcl.federation.server import FederationServer
from fedcl.registry import registry

# åˆ›å»ºæœåŠ¡å™¨
server = FederationServer(config)

# ä½¿ç”¨æ³¨å†Œçš„è®­ç»ƒå™¨
trainer_cls = registry.get_trainer('MyTrainer')
trainer = await server.initialize_with_trainer(trainer_cls, config)
```

### åœ¨FederationClientä¸­ä½¿ç”¨

```python
from fedcl.federation.client import FederationClient
from fedcl.registry import registry

# åˆ›å»ºå®¢æˆ·ç«¯
client = FederationClient(config)

# ä½¿ç”¨æ³¨å†Œçš„å­¦ä¹ å™¨
learner_cls = registry.get_learner('MyLearner')
learner = await client.initialize_with_learner(learner_cls, config)
```

## ğŸ“Š è°ƒè¯•å’Œç›‘æ§

### æŸ¥çœ‹ç»„ä»¶è¯¦ç»†ä¿¡æ¯

```python
from fedcl.api.discovery import list_registered_components

components = list_registered_components()
for comp_type, comps in components.items():
    print(f"\n{comp_type.upper()}:")
    for name, info in comps.items():
        print(f"  {name}:")
        print(f"    æè¿°: {info.get('description')}")
        print(f"    ç‰ˆæœ¬: {info.get('version')}")
        print(f"    ä½œè€…: {info.get('author')}")
```

### æ£€æŸ¥ç»„ä»¶çŠ¶æ€

```python
from fedcl.registry import registry

# æ£€æŸ¥ç»„ä»¶æ˜¯å¦å­˜åœ¨
if registry.has_component('MyLearner', 'learner'):
    print("MyLearner å·²æ³¨å†Œ")

# è·å–ç»„ä»¶æ•°é‡
count = registry.get_component_count()
print(f"å·²æ³¨å†Œç»„ä»¶: {count}")

# åˆ—å‡ºæ‰€æœ‰ç»„ä»¶åç§°
all_components = registry.list_all_components()
print(f"æ‰€æœ‰ç»„ä»¶: {all_components}")
```

## ğŸ‰ æ€»ç»“

MOE-FedCL çš„è£…é¥°å™¨æ³¨å†Œç³»ç»Ÿè®©æ‚¨å¯ä»¥ï¼š

1. **ç®€å•æ³¨å†Œ**ï¼šé€šè¿‡è£…é¥°å™¨ä¸€è¡Œä»£ç æ³¨å†Œç»„ä»¶
2. **è‡ªåŠ¨ç®¡ç†**ï¼šæ¡†æ¶è‡ªåŠ¨å‘ç°å’Œç®¡ç†æ‚¨çš„ç»„ä»¶
3. **ç±»å‹å®‰å…¨**ï¼šè‡ªåŠ¨éªŒè¯ç»„ä»¶ç±»å‹å’Œç»§æ‰¿å…³ç³»
4. **å…ƒæ•°æ®ä¸°å¯Œ**ï¼šæ”¯æŒç‰ˆæœ¬ã€ä½œè€…ã€æè¿°ç­‰è¯¦ç»†ä¿¡æ¯
5. **çµæ´»ä½¿ç”¨**ï¼šåœ¨è”é‚¦å­¦ä¹ ç³»ç»Ÿä¸­æ— ç¼é›†æˆå’Œä½¿ç”¨

å¼€å§‹ä½¿ç”¨è£…é¥°å™¨ç³»ç»Ÿï¼Œè®©æ‚¨çš„è”é‚¦å­¦ä¹ ç»„ä»¶ç®¡ç†æ›´åŠ ç®€å•é«˜æ•ˆï¼
