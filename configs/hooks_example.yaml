# configs/hooks_example.yaml
# Hook系统配置示例文件

hooks:
  # 度量记录钩子配置
  metrics_hook:
    # 启用的度量类型
    log_training: true        # 记录训练度量
    log_evaluation: true      # 记录评估度量  
    log_system: true          # 记录系统度量
    log_communication: true   # 记录通信度量
    
    # 记录频率配置
    training_frequency: 1     # 每1个batch记录一次训练度量
    evaluation_frequency: 1   # 每1轮记录一次评估度量
    system_frequency: 10      # 每10秒记录一次系统度量
    communication_frequency: 1 # 每1轮记录一次通信度量
    
    # 度量过滤配置
    metric_filters: []        # 只记录指定的度量（空表示记录所有）
    excluded_metrics:         # 排除的度量
      - "debug_info"
      - "internal_state"
      - "temp_variable"
    
    # 输出配置
    output_format: "both"     # context, file, both
    output_path: "./logs/metrics.jsonl"
    
    # 阶段和优先级配置
    phases:
      - phase: "after_batch"
        priority: 50
        enabled: true
      - phase: "after_epoch" 
        priority: 50
        enabled: true
      - phase: "on_evaluation"
        priority: 30
        enabled: true
      - phase: "on_aggregation"
        priority: 40
        enabled: true

  # 检查点保存钩子配置
  checkpoint_hook:
    # 保存频率和内容
    save_frequency: 1         # 每1轮保存一次检查点
    save_model: true          # 保存模型权重
    save_optimizer: true      # 保存优化器状态
    save_scheduler: true      # 保存学习率调度器状态
    save_experiment_state: true # 保存实验状态
    
    # 路径和命名配置
    checkpoint_dir: "./checkpoints"
    naming_pattern: "checkpoint_round_{round}_epoch_{epoch}"
    include_timestamp: true   # 在文件名中包含时间戳
    
    # 检查点管理配置
    max_checkpoints: 5        # 最多保留5个检查点
    compress: false           # 是否压缩检查点文件
    keep_best_only: false     # 是否只保留最佳检查点
    best_metric: "accuracy"   # 最佳检查点的评判度量
    best_mode: "max"          # max表示越大越好，min表示越小越好
    
    # 阶段和优先级配置
    phases:
      - phase: "after_round"
        priority: 10
        enabled: true
      - phase: "after_epoch"
        priority: 20
        enabled: false        # 默认不在每个epoch后保存
      - phase: "on_checkpoint"
        priority: 0
        enabled: true

# 全局Hook执行配置
hook_execution:
  # 错误处理策略
  error_policy: "continue"   # continue, stop, skip_phase
  timeout: 30.0              # 钩子执行超时时间（秒）
  
  # 并行执行配置
  parallel_execution: false  # 是否并行执行钩子
  max_workers: 4             # 并行执行的最大工作线程数
  
  # 日志配置
  logging:
    enable: true
    log_level: "INFO"
    log_performance: true
    log_hook_details: false
    
  # 监控配置
  monitoring:
    track_execution_time: true
    max_execution_time: 10.0
    alert_on_slow_hooks: true
    collect_stats: true
    stats_retention_count: 1000

# 实际使用示例配置
example_training_config:
  hooks:
    # 训练过程中的度量记录
    training_metrics:
      class: "MetricsHook"
      phase: "after_batch"
      priority: 50
      config:
        log_training: true
        log_system: false      # 训练时不记录系统度量（性能考虑）
        training_frequency: 10 # 每10个batch记录一次
        metric_filters: ["loss", "accuracy", "learning_rate"]
        output_format: "context"
    
    # 评估时的度量记录
    evaluation_metrics:
      class: "MetricsHook" 
      phase: "on_evaluation"
      priority: 30
      config:
        log_evaluation: true
        log_system: true       # 评估时记录系统度量
        evaluation_frequency: 1
        output_format: "both"
        output_path: "./logs/evaluation_metrics.jsonl"
    
    # 轮次结束时的检查点保存
    round_checkpoint:
      class: "CheckpointHook"
      phase: "after_round"
      priority: 10
      config:
        save_frequency: 1
        save_model: true
        save_optimizer: true
        save_experiment_state: true
        checkpoint_dir: "./checkpoints/rounds"
        max_checkpoints: 3
        keep_best_only: false
    
    # 最佳模型检查点保存
    best_checkpoint:
      class: "CheckpointHook"
      phase: "on_evaluation"
      priority: 5             # 高优先级，确保在评估后立即执行
      config:
        save_frequency: 1
        save_model: true
        save_optimizer: false  # 最佳模型不需要保存优化器状态
        save_scheduler: false
        save_experiment_state: true
        checkpoint_dir: "./checkpoints/best"
        max_checkpoints: 1
        keep_best_only: true
        best_metric: "accuracy"
        best_mode: "max"
        naming_pattern: "best_model_acc_{accuracy:.4f}"

# 不同场景的Hook配置
scenarios:
  # 调试场景 - 详细记录
  debug:
    hooks:
      debug_metrics:
        class: "MetricsHook"
        phase: "after_batch"
        priority: 100
        config:
          log_training: true
          log_system: true
          log_communication: true
          training_frequency: 1    # 每个batch都记录
          system_frequency: 1      # 频繁记录系统度量
          output_format: "both"
          output_path: "./debug/metrics.jsonl"
      
      debug_checkpoint:
        class: "CheckpointHook"
        phase: "after_epoch"
        priority: 50
        config:
          save_frequency: 1        # 每个epoch都保存
          save_model: true
          save_optimizer: true
          save_scheduler: true
          save_experiment_state: true
          checkpoint_dir: "./debug/checkpoints"
          max_checkpoints: 10      # 保留更多检查点用于调试
  
  # 生产场景 - 高效记录
  production:
    hooks:
      prod_metrics:
        class: "MetricsHook"
        phase: "after_batch"
        priority: 50
        config:
          log_training: true
          log_system: false        # 生产环境不记录系统度量
          log_communication: false
          training_frequency: 100  # 降低记录频率
          metric_filters: ["loss", "accuracy"]  # 只记录关键度量
          output_format: "file"
          output_path: "./prod/metrics.jsonl"
      
      prod_checkpoint:
        class: "CheckpointHook"
        phase: "after_round"
        priority: 10
        config:
          save_frequency: 5        # 每5轮保存一次
          save_model: true
          save_optimizer: false    # 生产环境不保存优化器状态
          save_scheduler: false
          save_experiment_state: true
          checkpoint_dir: "./prod/checkpoints"
          max_checkpoints: 3
          compress: true           # 压缩以节省空间
          keep_best_only: true
          best_metric: "accuracy"
  
  # 研究场景 - 全面记录
  research:
    hooks:
      research_metrics:
        class: "MetricsHook"
        phase: "after_batch"
        priority: 50
        config:
          log_training: true
          log_evaluation: true
          log_system: true
          log_communication: true
          training_frequency: 1
          evaluation_frequency: 1
          system_frequency: 5
          communication_frequency: 1
          metric_filters: []       # 记录所有度量
          excluded_metrics: []     # 不排除任何度量
          output_format: "both"
          output_path: "./research/all_metrics.jsonl"
      
      research_checkpoint:
        class: "CheckpointHook"
        phase: "after_round"
        priority: 10
        config:
          save_frequency: 1
          save_model: true
          save_optimizer: true
          save_scheduler: true
          save_experiment_state: true
          checkpoint_dir: "./research/checkpoints"
          max_checkpoints: 10      # 保留更多检查点用于分析
          include_timestamp: true
          keep_best_only: false
