# ====================================
# FedCL 服务端配置 - MNIST联邦学习演示
# ========================# 日志配置
logging:
  level: "DEBUG"                          # 日志级别
  save_logs: true                         # 是否保存日志
  log_frequency: 10                       # 日志频率
  log_dir: "logs/mnist_server"            # 日志目录======

# 服务端基本信息
server:
  id: "mnist_fedcl_server"
  name: "MNIST FedCL Server"
  version: "1.0"

# 通信配置
communication:
  host: "localhost"                        # 服务端主机地址
  port: 8080                              # 服务端端口（伪联邦模式）
  max_workers: 5                          # 最大并发工作线程数
  timeout: 120.0                          # 通信超时时间（秒）- 增加超时时间
  heartbeat_interval: 30                  # 心跳间隔（秒）

# 联邦学习配置
federated_config:
  rounds: 3                               # 联邦学习轮次
  min_clients: 3                          # 最少参与客户端数（等待所有客户端）
  max_clients: 3                          # 最多参与客户端数
  client_selection: "all"                 # 客户端选择策略: all/random/top_k
  min_client_updates: 3                   # 每轮聚合最少需要的客户端更新数（等待所有客户端）
  wait_for_all_clients: true              # 等待所有客户端完成训练
  aggregation_timeout: null               # 聚合超时时间（设为null表示无超时限制）

# 聚合器配置
aggregator:
  class: "fedavg"                         # 聚合器类（注册名称）
  type: "fedavg"                          # 聚合类型
  strategy: "weighted_average"            # 聚合策略
  
  # 聚合参数
  aggregation_params:
    weight_by_samples: true               # 是否按样本数量加权
    min_participation: 1.0                # 最小参与率（要求100%客户端参与）
    synchronous: true                     # 同步聚合模式
    wait_timeout: null                    # 等待客户端超时时间（设为null表示无超时限制）
    
  # 全局模型配置
  global_model:
    type: "mnist_cnn"                     # 使用CNN模型进行MNIST识别（与客户端保持一致）
    input_shape: [1, 28, 28]              # 输入形状 (channels, height, width)
    num_classes: 10                       # MNIST 10个类别 (0-9)
    hidden_size: 128                      # 隐藏层大小
    dropout_rate: 0.2                     # Dropout率
    activation: "relu"                    # 激活函数

# 服务端测试数据配置
test_datas:
  server_test_data:
    type: "StandardDataLoader"             # 数据加载器类型
    dataset:
      name: "MNIST"                        # 数据集名称
      path: "data/MNIST"                   # 数据集路径
      split: "test"                        # 数据集分割: train/test/val
      download: true                       # 是否自动下载
      transform: "basic"                   # 数据变换: basic/augmented/custom
    
    loader_params:
      batch_size: 64                       # 批大小
      shuffle: false                       # 是否打乱数据
      num_workers: 0                       # 数据加载工作进程数
      drop_last: false                     # 是否丢弃最后一个不完整batch
      pin_memory: false                    # 是否将数据加载到GPU内存

# 评估配置
evaluation:
  frequency: 1                            # 每轮评估频率
  metrics: ["accuracy", "loss"]           # 评估指标
  
  # 评估任务配置
  tasks:
    - evaluator: "server_accuracy_evaluator"
      test_data: "server_test_data"
      enabled: true

# 服务端评估器配置
evaluators:
  server_accuracy_evaluator:
    evaluator:
      class: "accuracy"                    # 评估器类别
      metrics: ["accuracy", "loss"]       # 评估指标
      test_data: "server_test_data"

# 系统配置
system:
  device: "cpu"                           # 计算设备
  random_seed: 42                         # 随机种子
  num_threads: 4                          # CPU线程数

# 实验配置
experiment:
  name: "mnist_fedcl_demo"                # 实验名称
  description: "MNIST手写数字识别联邦学习演示"
  output_dir: "experiments/mnist_demo"    # 输出目录

# Hook配置
hooks:
  enabled: true                           # 是否启用Hook系统
  
  # 检查点Hook配置 - 服务端在模型聚合后保存全局模型
  checkpoint:
    enabled: true                         # 启用检查点Hook
    save_frequency: 1                     # 保存频率（每1轮保存一次）
    save_model: true                      # 保存模型参数
    save_optimizer: false                 # 服务端通常不需要保存优化器状态
    save_scheduler: false                 # 不保存学习率调度器状态
    save_experiment_state: true           # 保存实验状态
    # checkpoint_dir: ""                  # 留空以使用实验级别目录
    naming_pattern: "server_checkpoint_{phase}_round_{round}" # 文件命名模式（已去掉时间戳）
    max_checkpoints: 5                    # 最大保留检查点数量
    keep_best_only: false                 # 保留所有检查点（用于演示）
    best_metric: "accuracy"               # 最佳模型评判指标
    best_mode: "max"                      # 最佳模式：准确率越高越好
    compress: false                       # 不压缩检查点文件
    
  checkpoint_hook:
    enabled: true                         # 启用检查点Hook
    phase: "after_round"                  # 执行阶段：每轮聚合后保存全局模型
    priority: 0                           # 优先级（数字越小优先级越高）
  
  # 评估Hook配置
  evaluation_hook:
    enabled: true
    priority: 5
    config:
      log_evaluation_results: true
      
  # 日志Hook配置
  logging_hook:
    enabled: true
    priority: 10
    config:
      log_training_progress: true
